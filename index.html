<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mattezoo</title>
<style>
  body{
    font-family: Arial, sans-serif;
    background:#eef2f7;
    margin:0;
    padding:24px 14px 40px;
  }
  #app{
    max-width:1100px;
    margin:0 auto;
    background:#fff;
    border-radius:14px;
    box-shadow:0 6px 22px rgba(0,0,0,0.09);
    border-top:6px solid #4CAF50;
    padding:18px 18px 22px;
    position:relative;
  }
  h1{margin:0 0 6px; color:#2e7d32;}
  h2{margin:0 0 8px;}
  p{margin:8px 0 10px; line-height:1.35;}
  .muted{color:#566; font-size:14px;}
  .row{display:flex; gap:14px; flex-wrap:wrap;}
  .card{
    background:#fff;
    border:1px solid #e6e6e6;
    border-radius:12px;
    padding:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.05);
  }

  /* Star pill */
  #starPill{
    position:absolute; top:14px; right:14px;
    background:#fffde7;
    border:1px solid #ffe082;
    border-radius:999px;
    padding:7px 12px;
    display:flex; align-items:center; gap:8px;
    font-weight:800; color:#f57f17;
  }
  #starPill span{font-size:18px;}

  .btn{
    border:none;
    background:#4CAF50;
    color:#fff;
    padding:9px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }
  .btn:hover{background:#43a047;}
  .btn.secondary{background:#546e7a;}
  .btn.secondary:hover{background:#455a64;}
  .btn.danger{background:#c62828;}
  .btn.danger:hover{background:#b71c1c;}
  .btn:disabled{opacity:.5; cursor:not-allowed;}

  input, select{
    padding:9px 10px;
    border-radius:10px;
    border:1px solid #cfcfcf;
    font-size:16px;
  }

  /* Game buttons */
  #trainGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:12px;
    margin-top:10px;
  }
  a.gameBtn{
    text-decoration:none;
    color:#1b5e20;
    background:#f1f8e9;
    border:2px solid #c5e1a5;
    border-radius:12px;
    padding:12px;
    display:block;
    transition:transform .08s, box-shadow .08s;
  }
  a.gameBtn:hover{
    transform:translateY(-2px);
    box-shadow:0 5px 14px rgba(0,0,0,0.12);
  }
  a.gameBtn h3{margin:0 0 6px;}
  a.gameBtn p{margin:0; font-size:14px; color:#2e3d2f;}

  /* Zoo zones grid */
  #zooGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(270px, 1fr));
    gap:12px;
    margin-top:10px;
  }
  .zone{
    border-radius:12px;
    border:2px solid rgba(0,0,0,0.08);
    overflow:hidden;
    position:relative;
    min-height:260px;
  }
  .zoneHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 10px 8px;
    font-weight:900;
    font-size:14px;
  }
  .zoneBody{padding:10px;}
  .zoneSub{
    font-size:12px;
    color:#345;
    margin:0 0 8px;
    font-weight:800;
  }

  /* Mini map (6x6) */
  .mapWrap{
    background:rgba(255,255,255,0.55);
    border:1px solid rgba(0,0,0,0.06);
    border-radius:12px;
    padding:10px;
  }
  .miniMap{
    display:grid;
    grid-template-columns:repeat(6, 1fr);
    gap:6px;
  }
  .cell{
    width:100%;
    aspect-ratio:1/1;
    border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,0.68);
    border:1px solid rgba(255,255,255,0.88);
    font-size:20px;
    user-select:none;
  }
  .cell.empty{
    opacity:0.22;
    font-size:16px;
  }
  .cell.path{
    opacity:0.65;
    font-size:18px;
  }

  /* Animals row */
  .animalsWrap{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    background:rgba(255,255,255,0.55);
    border:1px solid rgba(0,0,0,0.06);
    border-radius:12px;
    padding:10px;
    min-height:52px;
  }
  .animalTile{
    width:44px; height:44px;
    display:flex; align-items:center; justify-content:center;
    border-radius:12px;
    font-size:24px;
    background:rgba(255,255,255,0.68);
    border:1px solid rgba(255,255,255,0.88);
  }

  /* Rarity glow */
  .rar-common{ box-shadow:none; }
  .rar-uncommon{ box-shadow:0 0 0 2px rgba(30,200,80,0.22), 0 0 12px rgba(30,200,80,0.25); }
  .rar-rare{ box-shadow:0 0 0 2px rgba(40,120,240,0.22), 0 0 14px rgba(40,120,240,0.28); }
  .rar-epic{ box-shadow:0 0 0 2px rgba(160,70,240,0.26), 0 0 16px rgba(160,70,240,0.33); }

  /* Locked overlay */
  .lockedOverlay{
    position:absolute;
    inset:0;
    background:rgba(30,30,30,0.74);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    text-align:center;
  }
  .lockedOverlay .box{
    max-width:260px;
    background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:12px;
    padding:14px;
  }
  .lockedOverlay h4{margin:0 0 8px;}
  .lockedOverlay p{margin:0 0 10px; font-size:14px;}
  .reqLine{font-size:14px; margin:6px 0;}
  .reqOk{color:#a5ffb6;}
  .reqNo{color:#ffd1d1;}

  /* Zone themes */
  .forest{background:#eaf6df;}
  .savannah{background:#fff6d6;}
  .ocean{background:#dbeeff;}
  .ice{background:#dff7fb;}
  .fantasy{background:#f3e3fb;}

  /* Shop */
  #shop{
    display:grid;
    grid-template-columns:1.2fr 0.8fr;
    gap:12px;
  }
  @media (max-width: 900px){ #shop{grid-template-columns:1fr;} }
  .shopHeader{
    display:flex; align-items:center; gap:8px;
    font-weight:900; color:#e65100;
    margin-bottom:4px;
  }
  .shopHeader span{font-size:20px;}
  .shopControls{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:flex-end;
    margin:8px 0 10px;
  }
  .shopControls > div{display:flex; flex-direction:column; gap:6px;}
  .shopItems{ display:flex; flex-wrap:wrap; gap:8px; }
  .shopItemBtn{
    border:none;
    border-radius:10px;
    padding:8px 10px;
    cursor:pointer;
    background:#ffe0b2;
    color:#5d4037;
    font-weight:900;
  }
  .shopItemBtn:hover{background:#ffcc80;}
  .shopNote{
    font-size:13px;
    color:#6d4c41;
    margin-top:8px;
  }
  .toast{
    margin-top:8px;
    font-weight:900;
    color:#2e7d32;
  }

  .tiny{
    font-size:12px;
    color:#556;
    margin-top:10px;
  }
  code{background:#f5f5f5; padding:1px 6px; border-radius:8px;}
</style>
</head>
<body>
<div id="app">
  <div id="starPill"><span>‚≠ê</span> <span id="starsText">0</span></div>

  <h1>ü¶Å Mattezoo</h1>
  <p>
    Tr√§na matte, samla stj√§rnor ‚≠ê och bygg ditt zoo.
    <br>
    Nya omr√•den l√•ses upp <b>i ordning</b> och kr√§ver b√•de <b>10 ‚≠ê</b> och att du klarat ett uppdrag.
  </p>

  <div class="row">
    <div class="card" style="flex:1; min-width:280px;">
      <b>V√§lj tr√§ning</b>
      <div id="trainGrid">
        <a class="gameBtn" href="multiplikation.html">
          <h3>‚úñÔ∏è Multiplikation</h3>
          <p>Tr√§na tabeller och samla ‚≠ê.</p>
        </a>
        <a class="gameBtn" href="ekvationer.html">
          <h3>üßÆ Ekvationer</h3>
          <p>L√∂s ekvationer steg f√∂r steg.</p>
        </a>
        <a class="gameBtn" href="#" onclick="alert('Kommer snart!'); return false;">
          <h3>‚ûó Br√•k</h3>
          <p>Kommer snart‚Ä¶</p>
        </a>
      </div>

      <div class="tiny">
        <b>Uppdrag-r√§knare:</b>
        Multiplikation: <span id="progMult">0</span> | Ekvationer: <span id="progEq">0</span>
      </div>
    </div>

    <div class="card" style="flex:1; min-width:280px;">
      <b>D√∂p ditt zoo</b>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
        <input id="zooNameInput" placeholder="t.ex. Matteparken" style="flex:1; min-width:220px;">
        <button class="btn" id="saveNameBtn">Spara</button>
      </div>
      <div style="margin-top:10px;">
        <span class="muted">Just nu heter ditt zoo: </span>
        <b id="zooNameText">Mattezoo</b>
      </div>
      <div class="tiny">
        Tips: N√§r du kommer tillbaka fr√•n ett spel kan du klicka ‚ÄúSynka‚Äù i aff√§ren om du vill uppdatera direkt.
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h2 style="margin:0 0 6px;">üêæ Ditt zoo</h2>
    <div class="muted">
      Varje omr√•de har en liten karta. Dekorationer hamnar i rutor (som tr√§d l√§ngs stigar).
    </div>
    <div id="zooGrid"></div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="shopHeader"><span>üè™</span> Djuraff√§ren, dekorationer & blind bags</div>
    <div class="muted">V√§lj omr√•de och k√∂p djur, dekorationer eller en blind bag med √∂verraskning üéÅ</div>

    <div id="shop">
      <div>
        <div class="shopControls">
          <div>
            <label><b>Omr√•de</b></label>
            <select id="zoneSelect"></select>
          </div>
          <div>
            <label><b>K√∂p</b></label>
            <select id="buyMode">
              <option value="animals">Djur</option>
              <option value="decor">Dekoration</option>
              <option value="blind">Blind Bag üéÅ</option>
              <option value="unlock">L√•s upp omr√•de üîì</option>
            </select>
          </div>
        </div>

        <div class="shopItems" id="shopItems"></div>
        <div class="toast" id="toast"></div>
        <div class="shopNote" id="shopNote"></div>

        <div class="tiny">
          <b>Raritet:</b> Common (ingen glow), Uncommon (gr√∂n), Rare (bl√•), Epic (lila).
        </div>
      </div>

      <div class="card" style="background:#fafafa;">
        <b>Regler</b>
        <ul style="margin:8px 0 0; padding-left:18px; line-height:1.35;">
          <li>Uppl√•sning sker i ordning och kr√§ver <b>10 ‚≠ê</b> + ett uppdrag.</li>
          <li>Blind bag ger ett slumpdjur med olika raritet.</li>
          <li>Dekorationer placeras automatiskt p√• kartan.</li>
        </ul>

        <div style="margin-top:12px;">
          <button class="btn secondary" id="syncBtn">Synka (l√§s in sparat)</button>
          <button class="btn danger" id="resetBtn" style="margin-top:8px;">Nollst√§ll allt</button>
        </div>

        <div class="tiny" style="margin-top:10px;">
          <b>L√§rarnotis:</b> Spelsidorna b√∂r √∂ka r√§knare i
          <code>mathZooProgress</code> (se l√§ngst ner i filen).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE NYCKLAR
========================= */
const KEY_STARS   = "mathZooStars";
const KEY_NAME    = "mathZooName";
const KEY_UNLOCK  = "mathZooUnlockedZones";
const KEY_ANIMALS = "mathZooAnimalsByZoneV2"; // V2: djur √§r objekt med raritet
const KEY_DECOR   = "mathZooDecorGridByZone"; // grid 6x6 (36 rutor)
const KEY_PROG    = "mathZooProgress";        // { mult: n, eq: n }

/* =========================
   DATA: ZONER
========================= */
const ZONES = [
  { key:"forest",  name:"Skog",    icon:"üå≤", cls:"forest"  },
  { key:"savannah",name:"Savann",  icon:"üåµ", cls:"savannah"},
  { key:"ocean",   name:"Hav",     icon:"üåä", cls:"ocean"   },
  { key:"ice",     name:"Is",      icon:"‚ùÑÔ∏è", cls:"ice"     },
  { key:"fantasy", name:"Fantasi", icon:"üêâ", cls:"fantasy" }
];

/* =========================
   UPPDRAG F√ñR UPPL√ÖSNING
   (i ordning: savannah -> ocean -> ice -> fantasy)
========================= */
const UNLOCK_REQ = {
  savannah: { stars:10, mult:5, eq:0,  label:"Klara 5 multiplikationer" },
  ocean:    { stars:10, mult:0, eq:5,  label:"Klara 5 ekvationer" },
  ice:      { stars:10, mult:6, eq:6,  label:"Klara 6 multiplikationer + 6 ekvationer" },
  fantasy:  { stars:10, mult:10,eq:10, label:"Klara 10 multiplikationer + 10 ekvationer" }
};

/* =========================
   PRISER
========================= */
const PRICES = {
  animal: 3,
  decor: 2,
  blind: 4,
  unlock: 10
};

/* =========================
   DJURPOOLER + RARITET
========================= */
// Common/Uncommon/Rare/Epic per zon (enkelt att ut√∂ka)
const ANIMALS_POOL = {
  forest: {
    common:   ["üê≠","üêøÔ∏è","ü¶â","ü¶å","ü¶ä"],
    uncommon: ["üêª","ü¶î"],
    rare:     ["ü¶ù","ü¶°"],
    epic:     ["ü¶Ñ"]
  },
  savannah:{
    common:   ["ü¶Å","ü¶ì","üêò","ü¶í"],
    uncommon: ["üêÜ","ü¶õ"],
    rare:     ["ü¶è"],
    epic:     ["üê≤"]
  },
  ocean:{
    common:   ["üêü","üê¨","üêô","ü¶Ä"],
    uncommon: ["ü¶à","üê¢"],
    rare:     ["üê≥"],
    epic:     ["üßú‚Äç‚ôÄÔ∏è"]
  },
  ice:{
    common:   ["üêß","ü¶≠"],
    uncommon: ["ü¶ä","ü¶â"],
    rare:     ["üêª‚Äç‚ùÑÔ∏è"],
    epic:     ["ü¶Ñ"]
  },
  fantasy:{
    common:   ["üßö","üßô‚Äç‚ôÇÔ∏è","üßù","üê∫"],
    uncommon: ["ü¶Ñ"],
    rare:     ["üêâ"],
    epic:     ["üî•üêâ"] // vi visar som text (ok i emoji-rutor)
  }
};

// Raritetschans (summa = 1.0)
const RARITY_CHANCE = [
  { r:"common",   p:0.70 },
  { r:"uncommon", p:0.20 },
  { r:"rare",     p:0.09 },
  { r:"epic",     p:0.01 }
];

/* =========================
   DEKORATIONER
========================= */
const DECOR_BY_ZONE = {
  forest:   ["üå≤","üå≥","üçÑ","üåø","üåº","ü™µ"],
  savannah: ["üåµ","üåæ","üåª","ü™®","üåû","üèúÔ∏è"],
  ocean:    ["ü™∏","üêö","üå¥","üèùÔ∏è","ü´ß","ü™®"],
  ice:      ["‚õÑ","üèîÔ∏è","üßä","‚ùÑÔ∏è","ü™®","üß£"],
  fantasy:  ["‚ú®","üè∞","ü™Ñ","üîÆ","üåô","üïØÔ∏è"]
};

/* =========================
   MINI-MAP: PATH-ROUTE
   Vi markerar stigen med "üü´" i vissa rutor.
   (Samma stig i alla zoner f√∂r enkelhet.)
========================= */
const PATH_INDEXES = new Set([
  // enkel "S-form" i 6x6 (index = row*6 + col)
  0,1,2, 8,14,20, 21,22,23, 17,11,5
]);

/* =========================
   STATE
========================= */
let stars = 0;
let zooName = "Mattezoo";

// uppl√•sning (b√∂rjar med skog)
let unlocked = { forest:true, savannah:false, ocean:false, ice:false, fantasy:false };

// djur per zon: [{emoji, rarity}]
let animalsByZone = { forest:[], savannah:[], ocean:[], ice:[], fantasy:[] };

// dekor-grid per zon: array(36) med null eller emoji
let decorGridByZone = {
  forest:   Array(36).fill(null),
  savannah: Array(36).fill(null),
  ocean:    Array(36).fill(null),
  ice:      Array(36).fill(null),
  fantasy:  Array(36).fill(null)
};

// progress
let progress = { mult:0, eq:0 };

/* =========================
   STORAGE
========================= */
function safeParse(json, fallback){
  try{ return JSON.parse(json); }catch{ return fallback; }
}
function loadState(){
  stars = parseInt(localStorage.getItem(KEY_STARS) || "0", 10);

  const n = localStorage.getItem(KEY_NAME);
  if(n) zooName = n;

  const u = localStorage.getItem(KEY_UNLOCK);
  if(u){
    const parsed = safeParse(u, null);
    if(parsed && typeof parsed === "object"){
      unlocked = { ...unlocked, ...parsed };
    }
  } else {
    unlocked = { forest:true, savannah:false, ocean:false, ice:false, fantasy:false };
  }

  const a = localStorage.getItem(KEY_ANIMALS);
  if(a){
    const parsed = safeParse(a, null);
    if(parsed && typeof parsed === "object"){
      animalsByZone = {
        forest: parsed.forest || [],
        savannah: parsed.savannah || [],
        ocean: parsed.ocean || [],
        ice: parsed.ice || [],
        fantasy: parsed.fantasy || []
      };
    }
  }

  const d = localStorage.getItem(KEY_DECOR);
  if(d){
    const parsed = safeParse(d, null);
    if(parsed && typeof parsed === "object"){
      for(const z of ZONES){
        const arr = Array.isArray(parsed[z.key]) ? parsed[z.key] : Array(36).fill(null);
        decorGridByZone[z.key] = arr.length === 36 ? arr : Array(36).fill(null);
      }
    }
  }

  const p = localStorage.getItem(KEY_PROG);
  if(p){
    const parsed = safeParse(p, null);
    if(parsed && typeof parsed === "object"){
      progress = { mult: parsed.mult || 0, eq: parsed.eq || 0 };
    }
  }
}

function saveState(){
  localStorage.setItem(KEY_STARS, JSON.stringify(stars));
  localStorage.setItem(KEY_NAME, zooName);
  localStorage.setItem(KEY_UNLOCK, JSON.stringify(unlocked));
  localStorage.setItem(KEY_ANIMALS, JSON.stringify(animalsByZone));
  localStorage.setItem(KEY_DECOR, JSON.stringify(decorGridByZone));
  localStorage.setItem(KEY_PROG, JSON.stringify(progress));
}

/* =========================
   UI HELPERS
========================= */
function setToast(msg, good=true){
  const t = document.getElementById("toast");
  t.textContent = msg || "";
  t.style.color = good ? "#2e7d32" : "#b71c1c";
}
function updateStarsUI(){
  document.getElementById("starsText").textContent = String(stars);
}
function updateNameUI(){
  document.getElementById("zooNameText").textContent = zooName || "Mattezoo";
  document.getElementById("zooNameInput").value = zooName || "";
}
function updateProgressUI(){
  document.getElementById("progMult").textContent = String(progress.mult || 0);
  document.getElementById("progEq").textContent = String(progress.eq || 0);
}

/* =========================
   UNLOCK LOGIK
========================= */
function nextLockedZoneKey(){
  for(const z of ZONES){
    if(!unlocked[z.key]) return z.key;
  }
  return null;
}
function canUnlock(zoneKey){
  const req = UNLOCK_REQ[zoneKey];
  if(!req) return false;
  const okStars = stars >= req.stars;
  const okMult  = (progress.mult || 0) >= (req.mult || 0);
  const okEq    = (progress.eq || 0) >= (req.eq || 0);
  return okStars && okMult && okEq;
}
function unlockZone(zoneKey){
  if(unlocked[zoneKey]) return;
  if(!canUnlock(zoneKey)){
    setToast("Du uppfyller inte kraven √§nnu.", false);
    return;
  }
  // dra stj√§rnorna
  stars -= PRICES.unlock;
  unlocked[zoneKey] = true;
  saveState();
  updateStarsUI();
  renderZoo();
  renderShop();
  setToast(`üîì Du l√•ste upp ${ZONES.find(z=>z.key===zoneKey).name}!`);
}

/* =========================
   ZOO RENDER
========================= */
function renderZoneSelect(){
  const sel = document.getElementById("zoneSelect");
  sel.innerHTML = "";
  for(const z of ZONES){
    const opt = document.createElement("option");
    opt.value = z.key;
    opt.textContent = `${z.icon} ${z.name}`;
    sel.appendChild(opt);
  }
}
function rarityClass(r){
  if(r === "uncommon") return "rar-uncommon";
  if(r === "rare") return "rar-rare";
  if(r === "epic") return "rar-epic";
  return "rar-common";
}
function renderMiniMap(zoneKey){
  const grid = document.createElement("div");
  grid.className = "miniMap";

  const arr = decorGridByZone[zoneKey] || Array(36).fill(null);

  for(let i=0;i<36;i++){
    const cell = document.createElement("div");
    cell.className = "cell";

    const isPath = PATH_INDEXES.has(i);
    const hasDecor = !!arr[i];

    if(hasDecor){
      cell.textContent = arr[i];
      cell.classList.remove("empty");
      if(isPath) cell.classList.add("path");
    } else if(isPath){
      cell.textContent = "üü´";
      cell.classList.add("path");
    } else {
      cell.textContent = "¬∑";
      cell.classList.add("empty");
    }

    grid.appendChild(cell);
  }
  return grid;
}

function renderZoo(){
  const zooGrid = document.getElementById("zooGrid");
  zooGrid.innerHTML = "";

  for(const z of ZONES){
    const zoneDiv = document.createElement("div");
    zoneDiv.className = `zone ${z.cls}`;

    const head = document.createElement("div");
    head.className = "zoneHeader";
    head.innerHTML = `<div>${z.icon} ${z.name}</div><div>${unlocked[z.key] ? "üîì" : "üîí"}</div>`;

    const body = document.createElement("div");
    body.className = "zoneBody";

    const sub = document.createElement("div");
    sub.className = "zoneSub";
    sub.textContent = "Karta (dekorationer p√• rutor)";

    const mapWrap = document.createElement("div");
    mapWrap.className = "mapWrap";
    mapWrap.appendChild(renderMiniMap(z.key));

    const animalsWrap = document.createElement("div");
    animalsWrap.className = "animalsWrap";

    if(unlocked[z.key]){
      const arr = animalsByZone[z.key] || [];
      if(arr.length === 0){
        const hint = document.createElement("div");
        hint.className = "muted";
        hint.textContent = "Inga djur h√§r √§nnu. K√∂p i aff√§ren!";
        animalsWrap.appendChild(hint);
      } else {
        arr.forEach(obj => {
          const tile = document.createElement("div");
          tile.className = `animalTile ${rarityClass(obj.rarity)}`;
          tile.title = obj.rarity ? obj.rarity.toUpperCase() : "COMMON";
          tile.textContent = obj.emoji;
          animalsWrap.appendChild(tile);
        });
      }
    } else {
      const hint = document.createElement("div");
      hint.className = "muted";
      hint.textContent = "L√•st omr√•de. L√•s upp n√§r du uppfyller kraven.";
      animalsWrap.appendChild(hint);
    }

    body.appendChild(sub);
    body.appendChild(mapWrap);
    body.appendChild(animalsWrap);

    zoneDiv.appendChild(head);
    zoneDiv.appendChild(body);

    if(!unlocked[z.key] && z.key !== "forest"){
      const req = UNLOCK_REQ[z.key];
      const ov = document.createElement("div");
      ov.className = "lockedOverlay";

      const box = document.createElement("div");
      box.className = "box";

      const okStars = stars >= req.stars;
      const okMult = (progress.mult||0) >= (req.mult||0);
      const okEq = (progress.eq||0) >= (req.eq||0);

      box.innerHTML = `
        <h4>${z.name} √§r l√•st üîí</h4>
        <div class="reqLine ${okStars ? "reqOk" : "reqNo"}">‚≠ê ${req.stars} stj√§rnor (spendera)</div>
        <div class="reqLine ${okMult ? "reqOk" : "reqNo"}">‚úñÔ∏è Multiplikation: ${req.mult}</div>
        <div class="reqLine ${okEq ? "reqOk" : "reqNo"}">üßÆ Ekvationer: ${req.eq}</div>
        <p style="margin-top:10px;">Uppdrag: <b>${req.label}</b></p>
      `;
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = `L√•s upp ${z.name} (10‚≠ê)`;
      btn.disabled = !canUnlock(z.key);
      btn.onclick = () => unlockZone(z.key);
      box.appendChild(btn);

      ov.appendChild(box);
      zoneDiv.appendChild(ov);
    }

    zooGrid.appendChild(zoneDiv);
  }
}

/* =========================
   SHOP
========================= */
function renderShop(){
  const mode = document.getElementById("buyMode").value;
  const zone = document.getElementById("zoneSelect").value;
  const items = document.getElementById("shopItems");
  const note  = document.getElementById("shopNote");
  items.innerHTML = "";
  setToast("");

  if(mode === "animals"){
    note.innerHTML = `Pris: <b>${PRICES.animal} ‚≠ê</b> per djur.`;
  } else if(mode === "decor"){
    note.innerHTML = `Pris: <b>${PRICES.decor} ‚≠ê</b> per dekoration (placeras p√• kartan).`;
  } else if(mode === "blind"){
    note.innerHTML = `Pris: <b>${PRICES.blind} ‚≠ê</b> per blind bag üéÅ (raritet slumpas).`;
  } else {
    const next = nextLockedZoneKey();
    if(!next){
      note.innerHTML = `Alla omr√•den √§r uppl√•sta ‚úÖ`;
    } else {
      const zn = ZONES.find(z=>z.key===next).name;
      note.innerHTML = `N√§sta l√•sta omr√•de: <b>${zn}</b>. Kr√§ver 10 ‚≠ê + uppdrag.`;
    }
  }

  if(mode === "unlock"){
    const next = nextLockedZoneKey();
    if(!next){
      const done = document.createElement("div");
      done.className = "muted";
      done.textContent = "Alla omr√•den √§r redan uppl√•sta.";
      items.appendChild(done);
      return;
    }
    if(next === "forest"){
      // forest √§r alltid uppl√•st i v√•r design
      const msg = document.createElement("div");
      msg.className = "muted";
      msg.textContent = "Skogen √§r alltid uppl√•st.";
      items.appendChild(msg);
      return;
    }
    const zObj = ZONES.find(z=>z.key===next);
    const btn = document.createElement("button");
    btn.className = "shopItemBtn";
    btn.textContent = `üîì L√•s upp ${zObj.icon} ${zObj.name} (${PRICES.unlock}‚≠ê)`;
    btn.disabled = !canUnlock(next);
    btn.onclick = () => unlockZone(next);

    const req = UNLOCK_REQ[next];
    const info = document.createElement("div");
    info.className = "muted";
    info.style.marginTop = "8px";
    info.textContent = `Krav: 10‚≠ê + ${req.label}`;

    items.appendChild(btn);
    items.appendChild(info);
    return;
  }

  // Om zonen √§r l√•st, l√•t dem inte k√∂pa dit
  if(!unlocked[zone]){
    const msg = document.createElement("div");
    msg.className = "muted";
    msg.textContent = "Det h√§r omr√•det √§r l√•st. L√•s upp det f√∂rst.";
    items.appendChild(msg);
    return;
  }

  if(mode === "animals"){
    // k√∂p en specifik emoji (alltid common f√∂r enkelhet)
    const pool = ANIMALS_POOL[zone]?.common || [];
    pool.forEach(em => {
      const btn = document.createElement("button");
      btn.className = "shopItemBtn";
      btn.textContent = `${em} K√∂p (${PRICES.animal}‚≠ê)`;
      btn.disabled = stars < PRICES.animal;
      btn.onclick = () => buyAnimal(zone, em, "common");
      items.appendChild(btn);
    });
    return;
  }

  if(mode === "decor"){
    (DECOR_BY_ZONE[zone] || []).forEach(em => {
      const btn = document.createElement("button");
      btn.className = "shopItemBtn";
      btn.textContent = `${em} Dekor (${PRICES.decor}‚≠ê)`;
      btn.disabled = stars < PRICES.decor;
      btn.onclick = () => buyDecor(zone, em);
      items.appendChild(btn);
    });
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.style.marginTop = "8px";
    hint.textContent = "Dekorationer placeras automatiskt p√• en tom ruta (inte p√• stigen).";
    items.appendChild(hint);
    return;
  }

  if(mode === "blind"){
    const btn = document.createElement("button");
    btn.className = "shopItemBtn";
    btn.textContent = `üéÅ K√∂p Blind Bag (${PRICES.blind}‚≠ê)`;
    btn.disabled = stars < PRICES.blind;
    btn.onclick = () => buyBlindBag(zone);
    items.appendChild(btn);

    const extra = document.createElement("div");
    extra.className = "muted";
    extra.style.marginTop = "8px";
    extra.textContent = "Rariteter: Common 70%, Uncommon 20%, Rare 9%, Epic 1%.";
    items.appendChild(extra);
  }
}

/* =========================
   ACTIONS: K√ñP
========================= */
function buyAnimal(zoneKey, emoji, rarity){
  if(stars < PRICES.animal) return;
  stars -= PRICES.animal;
  animalsByZone[zoneKey].push({ emoji, rarity: rarity || "common" });
  saveState();
  updateStarsUI();
  renderZoo();
  renderShop();
  setToast(`Du k√∂pte ${emoji} till ${ZONES.find(z=>z.key===zoneKey).name}!`);
}

function placeDecorInGrid(zoneKey, emoji){
  const grid = decorGridByZone[zoneKey] || Array(36).fill(null);

  // samla tomma index som inte √§r stig
  const empty = [];
  for(let i=0;i<36;i++){
    if(PATH_INDEXES.has(i)) continue;
    if(grid[i] === null) empty.push(i);
  }
  if(empty.length === 0) return false;

  const pick = empty[Math.floor(Math.random()*empty.length)];
  grid[pick] = emoji;
  decorGridByZone[zoneKey] = grid;
  return true;
}

function buyDecor(zoneKey, emoji){
  if(stars < PRICES.decor) return;
  const ok = placeDecorInGrid(zoneKey, emoji);
  if(!ok){
    setToast("Kartan √§r full av dekorationer h√§r! V√§lj ett annat omr√•de.", false);
    return;
  }
  stars -= PRICES.decor;
  saveState();
  updateStarsUI();
  renderZoo();
  renderShop();
  setToast(`Dekoration ${emoji} placerades i ${ZONES.find(z=>z.key===zoneKey).name}!`);
}

function rollRarity(){
  const r = Math.random();
  let acc = 0;
  for(const item of RARITY_CHANCE){
    acc += item.p;
    if(r <= acc) return item.r;
  }
  return "common";
}

function pickFrom(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}

function buyBlindBag(zoneKey){
  if(stars < PRICES.blind) return;
  stars -= PRICES.blind;

  const rarity = rollRarity();
  const pool = ANIMALS_POOL[zoneKey]?.[rarity] || ANIMALS_POOL[zoneKey]?.common || ["üêæ"];
  const emoji = pickFrom(pool);

  animalsByZone[zoneKey].push({ emoji, rarity });

  saveState();
  updateStarsUI();
  renderZoo();
  renderShop();
  setToast(`üéÅ Blind Bag! Du fick: ${emoji} (${rarity.toUpperCase()})`);
}

/* =========================
   INIT / EVENTS
========================= */
function init(){
  loadState();
  updateStarsUI();
  updateNameUI();
  updateProgressUI();
  renderZoneSelect();
  renderZoo();
  renderShop();
}

document.getElementById("saveNameBtn").addEventListener("click", () => {
  const v = (document.getElementById("zooNameInput").value || "").trim();
  zooName = v || "Mattezoo";
  saveState();
  updateNameUI();
  setToast("Zoonamnet sparades!");
});

document.getElementById("buyMode").addEventListener("change", renderShop);
document.getElementById("zoneSelect").addEventListener("change", renderShop);

document.getElementById("syncBtn").addEventListener("click", () => {
  init();
  setToast("Synkat!");
});

document.getElementById("resetBtn").addEventListener("click", () => {
  if(!confirm("Vill du nollst√§lla allt? (stj√§rnor, djur, dekorationer, uppl√•sning, uppdrag)")) return;
  localStorage.removeItem(KEY_STARS);
  localStorage.removeItem(KEY_NAME);
  localStorage.removeItem(KEY_UNLOCK);
  localStorage.removeItem(KEY_ANIMALS);
  localStorage.removeItem(KEY_DECOR);
  localStorage.removeItem(KEY_PROG);
  init();
  setToast("Allt √§r nollst√§llt.");
});

init();

/* =========================
   KONTRAKT F√ñR SPEL-SIDORNA
   (L√§gg detta i dina spel n√§r eleven lyckas)
========================= */
/*
  // 1) Ge en stj√§rna
  let s = parseInt(localStorage.getItem("mathZooStars") || "0", 10);
  s += 1;
  localStorage.setItem("mathZooStars", JSON.stringify(s));

  // 2) √ñka uppdragsr√§knare
  // multiplikation.html:
  let p = JSON.parse(localStorage.getItem("mathZooProgress") || "{}");
  p.mult = (p.mult || 0) + 1;
  localStorage.setItem("mathZooProgress", JSON.stringify(p));

  // ekvationer.html:
  let p = JSON.parse(localStorage.getItem("mathZooProgress") || "{}");
  p.eq = (p.eq || 0) + 1;
  localStorage.setItem("mathZooProgress", JSON.stringify(p));
*/
</script>
</body>
</html>
